generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

//
// ========== ENUMS ==========
//

enum UserRole {
  SUPER_ADMIN
  ADMIN
  USER
}

// Outlet status granularity
enum OutletStatus {
  ACTIVE
  PAUSED
  DISABLED
}

enum BusinessCategory {
  HOTEL
  RESTAURANT
  GYM
  CLINIC
  OTHER
}

enum SubscriptionPlan {
  MONTHLY
  QUARTERLY
  HALF_YEARLY
  YEARLY
  CUSTOM
}

enum SubscriptionStatus {
  TRIAL
  ACTIVE
  PAST_DUE
  CANCELED
  INACTIVE
  EXPIRED
  UNPAID
  PAID
  PARTIAL
}

enum ApiStatus {
  ENABLED
  DISABLED
}

enum OnboardingStatus {
  PENDING
  COMPLETED
}

enum ReviewStatus {
  PENDING
  AUTO_REPLIED
  MANUAL_PENDING
  CLOSED
  ESCALATED
  COMPLETED
}

enum ManualQueueStatus {
  PENDING
  RESPONDED
  ESCALATED
}

enum PaymentStatus {
  PENDING
  SUCCESS
  FAILED
  CANCELLED
}

// CRITICAL FIX:
// Workflow state must not reuse ReviewStatus
// because workflow transitions are guarded separately.
enum ReviewWorkflowState {
  PENDING
  AUTO_REPLIED
  MANUAL_PENDING
  COMPLETED
  ESCALATED
}

//
// ========== MODELS ==========
//

model User {
  id                 String   @id @default(cuid())
  name               String
  email              String   @unique
  passwordHash       String
  role               UserRole @default(USER)

  twoFactorEnabled    Boolean @default(false)
  twoFactorSecret     String?
  twoFactorVerified   Boolean @default(false)

  lastLoginAt         DateTime?
  lastLoginIp         String?

  phoneNumber         String? // WhatsApp phone
  googleEmail         String? // Gmail for OAuth
  googleProfileId     String? // Google account ID
  googleRefreshToken  String? // Google refresh token for API access
  gmbAccountId        String? // Google Business Profile account ID
  whatsappNumber      String? // For receiving WhatsApp alerts

  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  deletedAt           DateTime?

  // relations
  outlets              Outlet[]
  auditLogs            AuditLog[]
  apiKeys              ApiKey[]
  refreshTokens        RefreshToken[]
  payments             Payment[]
  subscriptionAudits   SubscriptionAuditLog[]
  assignedManualReviews ManualReviewQueue[]
  googleConnectTokens   GoogleConnectToken[]

  @@index([email])
  @@index([role])
  @@index([deletedAt])
}

model Outlet {
  id                    String           @id @default(cuid())
  name                  String
  groupName             String?
  primaryContactName    String
  contactEmail          String           @unique
  contactPhone          String           @unique

  category              BusinessCategory @default(OTHER)
  subscriptionPlan      SubscriptionPlan @default(MONTHLY)

  subscriptionStatus    SubscriptionStatus @default(TRIAL)
  apiStatus             ApiStatus          @default(DISABLED)
  onboardingStatus      OnboardingStatus   @default(PENDING)
  status                OutletStatus       @default(ACTIVE)

  googlePlaceId         String?
  googleLocationName    String?
  googleConnected       Boolean            @default(false)

  createdAt             DateTime          @default(now())
  updatedAt             DateTime          @updatedAt

  // owner
  userId                String
  user                  User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  // relations
  reviews               Review[]
  billing               Billing?
  apiKeys               ApiKey[]
  auditLogs             AuditLog[]
  payments              Payment[]
  subscriptionAudits    SubscriptionAuditLog[]
  manualReviewQueue     ManualReviewQueue[]
  googleConnectTokens   GoogleConnectToken[]
  googleIntegration     GoogleIntegration?

  @@index([userId])
  @@index([status])
  @@index([subscriptionStatus])
  @@index([apiStatus])
  @@index([onboardingStatus])
}

model Review {
  id              String      @id @default(cuid())

  // RECOMMENDED:
  // Uniqueness guarantees idempotency at DB level.
  // Prevents duplicate review ingestion.
  googleReviewId  String?     @unique

  rating          Int
  customerName    String
  reviewText      String
  aiReplyText     String?
  manualReplyText String?
  status          ReviewStatus @default(PENDING)
  platform        String       @default("GMB")

  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  outletId        String
  outlet          Outlet       @relation(fields: [outletId], references: [id], onDelete: Cascade)

  auditLogs       AuditLog[]
  manualQueue     ManualReviewQueue?
  reviewWorkflow  ReviewWorkflow?

  @@index([outletId])
  @@index([status])
  @@index([rating])
  @@index([createdAt])
}

model ManualReviewQueue {
  id              String            @id @default(cuid())

  reviewId         String            @unique
  review           Review            @relation(fields: [reviewId], references: [id], onDelete: Cascade)

  outletId         String
  outlet           Outlet            @relation(fields: [outletId], references: [id], onDelete: Cascade)

  assignedAdminId  String?
  assignedAdmin    User?             @relation(fields: [assignedAdminId], references: [id], onDelete: SetNull)

  reminderCount    Int               @default(0)
  nextReminderAt   DateTime?
  status           ManualQueueStatus @default(PENDING)

  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt

  @@index([reviewId])
  @@index([outletId])
  @@index([assignedAdminId])
  @@index([status])
  @@index([nextReminderAt])
}

model Billing {
  id          String             @id @default(cuid())
  status      SubscriptionStatus @default(TRIAL)
  trialEndsAt DateTime?
  paidUntil   DateTime?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  outletId    String  @unique
  outlet      Outlet  @relation(fields: [outletId], references: [id], onDelete: Cascade)

  payments    Payment[]

  @@index([status])
}

model ApiKey {
  id        String   @id @default(cuid())
  keyHash   String   @unique
  expiresAt DateTime
  isActive  Boolean  @default(true)
  lastUsedAt DateTime?
  createdAt DateTime @default(now())

  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  outletId  String
  outlet    Outlet   @relation(fields: [outletId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([outletId])
  @@index([expiresAt])
}

model AuditLog {
  id        String   @id @default(cuid())
  action    String
  entity    String
  entityId  String
  details   String?
  ip        String?
  userAgent String?
  createdAt DateTime @default(now())

  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  outletId  String?
  outlet    Outlet?  @relation(fields: [outletId], references: [id], onDelete: SetNull)

  reviewId  String?
  review    Review?  @relation(fields: [reviewId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([action])
  @@index([entity])
  @@index([createdAt])
}

model SubscriptionAuditLog {
  id        String   @id @default(cuid())

  outletId  String
  outlet    Outlet   @relation(fields: [outletId], references: [id], onDelete: Cascade)

  adminId   String
  admin     User     @relation(fields: [adminId], references: [id], onDelete: Cascade)

  action    String
  oldValue  String?
  newValue  String?
  remarks   String?

  createdAt DateTime @default(now())

  @@index([outletId])
  @@index([adminId])
  @@index([action])
  @@index([createdAt])
}

model IpAllowlist {
  id          String  @id @default(cuid())
  ip          String  @unique
  description String?
  isActive    Boolean @default(true)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([ip])
  @@index([isActive])
}

model Payment {
  id                String        @id @default(cuid())
  razorpayOrderId   String        @unique
  razorpayPaymentId String?       @unique
  amount            Int
  currency          String        @default("INR")
  status            PaymentStatus @default(PENDING)

  planType          SubscriptionPlan

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  userId            String
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  outletId          String
  outlet            Outlet   @relation(fields: [outletId], references: [id], onDelete: Cascade)

  billingId         String?
  billing           Billing? @relation(fields: [billingId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([outletId])
  @@index([status])
  @@index([razorpayOrderId])
}

model RefreshToken {
  id        String   @id @default(cuid())
  tokenHash String   @unique

  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([expiresAt])
}

model ReviewWorkflow {
  reviewId       String             @id
  review         Review              @relation(fields: [reviewId], references: [id], onDelete: Cascade)

  // CRITICAL FIX:
  // Use ReviewWorkflowState enum (not ReviewStatus)
  currentState   ReviewWorkflowState
  reminderCount  Int                @default(0)

  lastActionAt   DateTime           @default(now())
  lastReminderAt DateTime?
  nextReminderAt DateTime?

  createdAt      DateTime           @default(now())
  updatedAt      DateTime           @updatedAt

  @@index([currentState])
  @@index([nextReminderAt])
}

// Google Connect Tokens for outlet-specific Google OAuth flow
model GoogleConnectToken {
  id        String   @id @default(cuid())
  outletId  String?
  outlet    Outlet?  @relation(fields: [outletId], references: [id], onDelete: Cascade)

  userId    String?
  user      User?    @relation(fields: [userId], references: [id], onDelete: Cascade)

  token     String   @unique
  expiresAt DateTime
  usedAt    DateTime?
  lastSentAt DateTime?
  createdAt DateTime @default(now())

  @@index([token])
  @@index([outletId])
  @@index([userId])
  @@index([expiresAt])
}

// Google Business Profile integrations per outlet
model GoogleIntegration {
  id           String   @id @default(cuid())
  outletId     String   @unique
  outlet       Outlet   @relation(fields: [outletId], references: [id], onDelete: Cascade)

  googleEmail  String
  refreshToken String
  connectedAt  DateTime @default(now())

  @@index([outletId])
}
